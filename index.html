<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pro Laser Ruler</title>
    <style>
        :root { 
            --pink: #ff007f; --cyan: #00f2ff; --yellow: #ffd700; 
            --bg: #000; --ruler-bg: #080808; --text: #fff; --mm: #777; --border: #333;
        }
        
        body.light-mode {
            --bg: #fff; --ruler-bg: #f9f9f9; --text: #000; --mm: #888; --border: #ddd;
            --pink: #d0006f; --cyan: #008b9b; --yellow: #cfa000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; position: fixed; }

        /* HOME SCREEN */
        #home-menu { position: fixed; inset: 0; background: var(--bg); z-index: 8000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .menu-btn { width: 280px; padding: 18px; font-size: 18px; font-weight: bold; border-radius: 50px; border: 2px solid var(--border); background: var(--ruler-bg); color: var(--text); cursor: pointer; }
        .menu-btn.primary { background: var(--pink); border: none; color: #fff; }

        /* UI CONTROLS */
        .controls { position: fixed; top: 180px; right: 40px; display: flex; flex-direction: column; gap: 15px; z-index: 3000; }
        .icon-btn { width: 65px; height: 65px; background: var(--ruler-bg); border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }

        #display { 
            position: fixed; top: 180px; left: 180px; padding: 18px; 
            background: var(--ruler-bg); z-index: 2000; border-radius: 12px; 
            border: 1px solid var(--border); min-width: 160px;
        }
        .val { font-size: 38px; font-weight: 900; color: var(--yellow); display: block; text-align: center; line-height: 1; }
        .unit-label { font-size: 10px; color: var(--mm); text-transform: uppercase; display: block; text-align: center; margin-top: 4px;}

        /* RULER */
        .ruler { position: fixed; background: var(--ruler-bg); z-index: 10; transition: opacity 0.3s; }
        #h-ruler { top: 30px; left: 30px; width: 200%; height: 115px; border-bottom: 2px solid var(--border); }
        #v-ruler { top: 30px; left: 30px; width: 115px; height: 200%; border-right: 2px solid var(--border); }
        .tick { position: absolute; display: flex; align-items: center; justify-content: center; }
        .major-mark { background: var(--pink); z-index: 5; }
        .minor-mark { background: var(--mm); z-index: 4; }
        .num-h { color: var(--text); font-size: 20px; font-weight: 900; position: absolute; top: 70px; }
        .num-v { color: var(--text); font-size: 20px; font-weight: 900; position: absolute; left: 70px; }

        /* TRACKS */
        .track { position: fixed; background: var(--ruler-bg); border-radius: 40px; border: 1px solid var(--border); z-index: 2000; }
        #h-track { bottom: 40px; left: 180px; right: 40px; height: 65px; }
        #v-track { top: 380px; right: 40px; bottom: 120px; width: 65px; }
        .thumb { position: absolute; background: var(--pink); border-radius: 50%; width: 55px; height: 55px; box-shadow: 0 0 20px var(--pink); }

        /* CALIBRATION UI */
        #cal-ui { display: none; position: fixed; inset: 0; background: #000; z-index: 6000; }
        #blue-line { left: 50px; background: var(--cyan); width: 3px; height: 100vh; position: fixed; z-index: 6500; box-shadow: 0 0 10px var(--cyan); }
        #yellow-line { left: 300px; background: var(--yellow); width: 3px; height: 100vh; position: fixed; z-index: 6500; box-shadow: 0 0 10px var(--yellow); }
        #cal-scale-content { position: absolute; top: 30%; left: 50px; width: 200%; height: 200px; pointer-events: none; }
        
        #h-laser, #v-laser { position: fixed; background: var(--yellow); z-index: 100; display: none; }
        .btn-main { padding: 18px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 50px; cursor: pointer; background: var(--pink); text-align: center; }
        .btn-cancel { background: #333; color: #fff; }

        /* DIAMETER MODE UI */
        #diameter-ui { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 7500; flex-direction: column; align-items: center; justify-content: center; }
        #circle-preview { border: 2px dashed var(--pink); border-radius: 50%; position: absolute; pointer-events: none; box-shadow: 0 0 20px rgba(255, 0, 127, 0.2); }
    </style>
</head>
<body>

<div id="home-menu">
    <h1 style="color:var(--pink); letter-spacing:5px;">PRO RULER</h1>
    <button class="menu-btn primary" onclick="launchApp()">START MEASURING</button>
    <button class="menu-btn" onclick="openDiameter()">DIAMETER MODE</button>
    <button class="menu-btn" onclick="showCal()">PHYSICAL CALIBRATION</button>
    <div style="width: 280px; display: flex; gap: 10px;">
        <button class="menu-btn" style="flex: 1; font-size: 14px;" onclick="exportCalibration()">EXPORT</button>
        <button class="menu-btn" style="flex: 1; font-size: 14px;" onclick="triggerImport()">IMPORT</button>
    </div>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importCalibration(event)">
    <p id="status-msg" style="font-size: 12px; color: var(--mm);"></p>
</div>

<div id="diameter-ui">
    <div class="controls">
        <div class="icon-btn" onclick="goHome()">üè†</div>
        <div class="icon-btn" onclick="toggleTheme()">üåì</div>
    </div>
    <div id="display">
        <span id="dia-cm" class="val">5.0</span><span class="unit-label">Diameter (CM)</span>
        <div style="margin:10px 0; border-top:1px solid var(--border);"></div>
        <span id="dia-in" class="val" style="color:var(--cyan); font-size:32px;">1.97</span><span class="unit-label">Inches</span>
    </div>
    <div id="circle-preview"></div>
    <div id="dia-track" class="track" style="bottom:40px; left:50px; right:50px; height:65px;">
        <div id="dia-thumb" class="thumb" style="top:4px; left:50%;"></div>
    </div>
</div>

<div id="cal-ui">
    <div id="blue-line"></div>
    <div id="yellow-line"></div>
    <div id="cal-display" style="position:fixed; top:20px; right:20px; z-index:7000; background:rgba(0,0,0,0.8); padding:15px; border:2px solid var(--pink); border-radius:12px; text-align:center;">
        <span id="cal-cm-val" style="font-size:40px; font-weight:bold; color:var(--pink);">0.0</span>
        <div style="font-size:10px; color:#888;">MATCH PHYSICAL CM</div>
    </div>
    <div id="cal-scale-content"></div>
    
    <div style="position:fixed; bottom:120px; left:50%; transform:translateX(-50%); width:90%; max-width:420px; background:#111; padding:15px; border-radius:15px; border:1px solid #444; z-index:7000;">
        <div style="text-align:center; font-size:12px; color:var(--cyan); margin-bottom:10px;">BLUE LINE IS FIXED AT 0</div>
        <div style="display:flex; gap:10px; flex-direction: column;">
            <input type="number" id="cal-input" value="10" style="width:100%; background:#000; color:var(--yellow); border:2px solid var(--pink); padding:12px; border-radius:10px; text-align:center; font-size:20px; font-weight:bold;">
            <div style="display:flex; gap:10px;">
                <button class="btn-main btn-cancel" style="flex:1;" onclick="goHome()">CANCEL</button>
                <button class="btn-main" style="flex:2;" onclick="saveCal()">SAVE & EXIT</button>
            </div>
        </div>
    </div>
    <div id="cal-track" class="track" style="bottom:40px; left:50px; right:50px; height:65px;">
        <div id="cal-thumb" class="thumb" style="top:4px; left:250px;"></div>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="controls">
        <div class="icon-btn" onclick="goHome()">üè†</div>
        <div class="icon-btn" onclick="toggleTheme()">üåì</div>
        <div class="icon-btn" id="unit-btn" onclick="toggleUnit()">INCH</div>
    </div>
    <div id="display">
        <span id="cm-out" class="val">0.0</span><span class="unit-label">Centimeters</span>
        <div style="margin:10px 0; border-top:1px solid var(--border);"></div>
        <span id="in-out" class="val" style="color:var(--cyan); font-size:32px;">0.00</span><span class="unit-label">Inches</span>
    </div>
    <div id="h-ruler" class="ruler"></div><div id="v-ruler" class="ruler"></div>
    <div id="h-laser" style="width:3px; height:100%;"></div><div id="v-laser" style="height:3px; width:100%;"></div>
    <div id="h-track" class="track"><div id="h-thumb" class="thumb" style="top:4px;"></div></div>
    <div id="v-track" class="track"><div id="v-thumb" class="thumb" style="left:4px;"></div></div>
</div>

<script>
    let ppi = parseFloat(localStorage.getItem('viz_ppi')) || 115;
    let rulerType = 'cm';
    let yellowX = 300; 

    function goFS() { if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen(); }

    function goHome() {
        document.getElementById('home-menu').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
        document.getElementById('cal-ui').style.display = 'none';
        document.getElementById('diameter-ui').style.display = 'none';
    }

    function launchApp() {
        goFS();
        document.getElementById('home-menu').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        buildRulers();
    }

    // --- DIAMETER MODE ---
    function openDiameter() {
        goFS();
        document.getElementById('home-menu').style.display = 'none';
        document.getElementById('diameter-ui').style.display = 'flex';
        updateCircle(window.innerWidth / 3);
    }

    function updateCircle(px) {
        const circle = document.getElementById('circle-preview');
        circle.style.width = px + 'px';
        circle.style.height = px + 'px';
        const inch = px / ppi;
        document.getElementById('dia-cm').innerText = (inch * 2.54).toFixed(2);
        document.getElementById('dia-in').innerText = inch.toFixed(2);
    }

    document.getElementById('dia-track').addEventListener('touchmove', (e) => {
        const r = document.getElementById('dia-track').getBoundingClientRect();
        let x = Math.max(0, Math.min(e.touches[0].pageX - r.left - 27, r.width - 55));
        document.getElementById('dia-thumb').style.left = x + 'px';
        const size = (x / (r.width - 55)) * (Math.min(window.innerWidth, window.innerHeight) - 100);
        updateCircle(size);
    });

    // --- CALIBRATION ---
    function showCal() {
        goFS();
        document.getElementById('home-menu').style.display = 'none';
        document.getElementById('cal-ui').style.display = 'block';
        renderCalScale();
    }

    function renderCalScale() {
        const content = document.getElementById('cal-scale-content');
        content.innerHTML = '';
        const mmPx = ppi / 25.4;
        for(let i=0; i<=100; i++) {
            const div = document.createElement('div');
            div.style.position = 'absolute';
            div.style.left = (i * mmPx) + 'px';
            if(i % 10 === 0) {
                div.className = 'tick major-mark'; div.style.width='2px'; div.style.height='100px';
                div.innerHTML = `<span style="position:absolute; top:110px; color:var(--pink); font-weight:bold; font-size:22px; transform:translateX(-50%);">${i/10}</span>`;
            } else {
                div.className = 'tick minor-mark'; div.style.width='1px'; div.style.height = (i%5===0)?'55px':'35px';
            }
            content.appendChild(div);
        }
        updateCalVisuals();
    }

    function updateCalVisuals() {
        document.getElementById('yellow-line').style.left = yellowX + 'px';
        const distPx = yellowX - 50;
        const currentCm = (distPx / (ppi / 2.54)).toFixed(1);
        document.getElementById('cal-cm-val').innerText = Math.max(0, currentCm);
    }

    function saveCal() {
        const physicalCm = parseFloat(document.getElementById('cal-input').value);
        const distPx = yellowX - 50;
        if(physicalCm > 0 && distPx > 0) {
            ppi = (distPx / physicalCm) * 2.54;
            localStorage.setItem('viz_ppi', ppi);
            location.reload();
        }
    }

    async function exportCalibration() {
        const data = JSON.stringify({ ppi: ppi, timestamp: new Date().toISOString() }, null, 2);
        try {
            if (window.showSaveFilePicker) {
                const handle = await window.showSaveFilePicker({ suggestedName: 'ruler_calibration.json' });
                const writable = await handle.createWritable();
                await writable.write(data); await writable.close();
            } else {
                const blob = new Blob([data], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = 'ruler_calibration.json'; a.click();
            }
        } catch (err) {}
    }

    function triggerImport() { document.getElementById('importFile').click(); }

    function importCalibration(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (json.ppi) { ppi = json.ppi; localStorage.setItem('viz_ppi', ppi); location.reload(); }
            } catch (err) { alert("Invalid File"); }
        };
        reader.readAsText(file);
    }

    const calThumb = document.getElementById('cal-thumb');
    calThumb.addEventListener('touchmove', (e) => {
        const rect = document.getElementById('cal-track').getBoundingClientRect();
        let x = e.touches[0].pageX - rect.left - 27;
        x = Math.max(0, Math.min(x, rect.width - 55));
        calThumb.style.left = x + 'px';
        yellowX = 50 + (x / (rect.width - 55)) * (window.innerWidth - 100);
        updateCalVisuals();
    });

    // --- RULER FUNCTIONS (UNCHANGED) ---
    function buildRulers() {
        const h = document.getElementById('h-ruler'), v = document.getElementById('v-ruler');
        h.innerHTML = ''; v.innerHTML = '';
        const spc = (rulerType === 'cm') ? (ppi / 25.4) : (ppi / 8);
        const freq = (rulerType === 'cm') ? 10 : 8;
        for(let i=0; i <= 500; i++) {
            const pos = i * spc;
            if(pos <= window.innerWidth + 200) {
                const t = document.createElement('div'); t.className = 'tick'; t.style.left = pos + 'px';
                if(i % freq === 0) {
                    t.classList.add('major-mark'); t.style.width='2.5px'; t.style.height='80px';
                    t.innerHTML = `<span class="num-h">${i/freq}</span>`;
                } else {
                    t.classList.add('minor-mark'); t.style.width='1.5px'; t.style.height=(i%(freq/2)===0)?'45px':'25px';
                }
                h.appendChild(t);
            }
            if(pos <= window.innerHeight + 500) {
                const t = document.createElement('div'); t.className = 'tick'; t.style.top = pos + 'px'; t.style.right='0';
                if(i % freq === 0) {
                    t.classList.add('major-mark'); t.style.height='2.5px'; t.style.width='80px';
                    t.innerHTML = `<span class="num-v">${i/freq}</span>`;
                } else {
                    t.classList.add('minor-mark'); t.style.height='1.5px'; t.style.width=(i%(freq/2)===0)?'45px':'25px';
                }
                v.appendChild(t);
            }
        }
    }

    const hT = document.getElementById('h-thumb'), vT = document.getElementById('v-thumb');
    const hL = document.getElementById('h-laser'), vL = document.getElementById('v-laser');
    const hR = document.getElementById('h-ruler'), vR = document.getElementById('v-ruler');

    hT.addEventListener('touchmove', (e) => {
        const r = document.getElementById('h-track').getBoundingClientRect();
        let x = Math.max(0, Math.min(e.touches[0].pageX - r.left - 27, r.width - 55));
        hT.style.left = x + 'px';
        const sx = (x / (r.width - 55)) * (window.innerWidth - 30) + 30;
        hL.style.left = sx + 'px'; hL.style.display = 'block'; vL.style.display = 'none';
        vR.style.opacity = '0.1'; hR.style.opacity = '1';
        updateDisplay(sx - 30);
    });

    vT.addEventListener('touchmove', (e) => {
        const r = document.getElementById('v-track').getBoundingClientRect();
        let y = Math.max(0, Math.min(e.touches[0].pageY - r.top - 27, r.height - 55));
        vT.style.top = y + 'px';
        const sy = (y / (r.height - 55)) * (window.innerHeight - 30) + 30;
        vL.style.top = sy + 'px'; vL.style.display = 'block'; hL.style.display = 'none';
        hR.style.opacity = '0.1'; vR.style.opacity = '1';
        updateDisplay(sy - 30);
    });

    function updateDisplay(px) {
        const inch = px / ppi;
        document.getElementById('cm-out').innerText = (inch * 2.54).toFixed(1);
        document.getElementById('in-out').innerText = inch.toFixed(2);
    }

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('ruler_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    }

    function toggleUnit() {
        rulerType = (rulerType === 'cm') ? 'inch' : 'cm';
        document.getElementById('unit-btn').innerText = (rulerType === 'cm') ? 'INCH' : 'CM';
        buildRulers();
    }
</script>
</body>
</html>
